--REFER BUG 4582497

--MAIN TABLE 
SELECT 

TXN.ORGANIZATION_ID ORG_ID, 
TXN.INVENTORY_ITEM_ID ITEM_ID, 
TXN.SUBINVENTORY_CODE SUB, 
TXN.IMT_QTY IMT_QTY, 
ONHAND.QTY ONHAND_QTY, 
(TXN.IMT_QTY - NVL(ONHAND.QTY,0)) AS "QTY_DIFF" 

-- MAIN TABLE FROM
FROM 
      
(

--START TABLE 1
SELECT 
    IMT.ORGANIZATION_ID, 
	IMT.INVENTORY_ITEM_ID, 
    IMT.SUBINVENTORY_CODE, 
	SUM(IMT.PRIMARY_QUANTITY) AS "IMT_QTY" 
-- TABLE 1 FROM   
	FROM 
	
	INV_MATERIAL_TXNS IMT, 
    INV_SECONDARY_INVENTORIES ISI 
--TABLE 1 CONDITIONS       
	WHERE 	
	
	ISI.ORGANIZATION_ID=IMT.ORGANIZATION_ID 
	AND ISI.SECONDARY_INVENTORY_NAME=IMT.SUBINVENTORY_CODE 
	AND ISI.QUANTITY_TRACKED=1 
	AND IMT.TRANSACTION_ACTION_ID NOT IN (5,6,24,30,50,51,52,55,26,7,11,17,10,9,13,14,15,22)
	AND NVL(IMT.LOGICAL_TRANSACTION, -1) <> 1
	AND IMT.LPN_ID IS NULL AND IMT.TRANSFER_LPN_ID IS NULL 
	AND IMT.CONTENT_LPN_ID IS NULL 
	
--TABLE 1 GROUPING	
		
	GROUP BY IMT.ORGANIZATION_ID, IMT.INVENTORY_ITEM_ID, 
		     IMT.SUBINVENTORY_CODE) AS "TXN", --END TABLE 1,
					 
--START TABLE 2

(SELECT 
	IOQD.ORGANIZATION_ID, 
	IOQD.INVENTORY_ITEM_ID, 
    IOQD.SUBINVENTORY_CODE, 
	SUM(IOQD.PRIMARY_TRANSACTION_QUANTITY) AS "QTY" 
-- TABLE 2 FROM         	
    FROM  
	
	INV_ONHAND_QUANTITIES_DETAIL IOQD, 
    INV_SECONDARY_INVENTORIES ISI 
       
-- TABLE 2 CONDTIONS	   
	WHERE 	IOQD.ORGANIZATION_ID=ISI.ORGANIZATION_ID 
			AND ISI.SECONDARY_INVENTORY_NAME=IOQD.SUBINVENTORY_CODE 
			AND ISI.QUANTITY_TRACKED=1 
			AND NVL(IOQD.CONTAINERIZED_FLAG,2) = 2 
            
-- TABLE 2 GROUPING			
	GROUP BY IOQD.ORGANIZATION_ID, IOQD.INVENTORY_ITEM_ID, 
             IOQD.SUBINVENTORY_CODE) AS "ONHAND" --END TABLE 2
				  
-- MAIN TABLE CONDITIONS 

WHERE 
	
	TXN.INVENTORY_ITEM_ID = ONHAND.INVENTORY_ITEM_ID (+) 
    AND TXN.ORGANIZATION_ID   = ONHAND.ORGANIZATION_ID (+) 
    AND TXN.SUBINVENTORY_CODE = ONHAND.SUBINVENTORY_CODE (+) 
    AND ABS(TXN.IMT_QTY - NVL(ONHAND.QTY,0)) > 0 
    AND EXISTS (--TABLE 3
	            SELECT 1 FROM INV_ORG_PARAMETERS 
                --TABLE 3 CONDITIONS      
                WHERE ORGANIZATION_ID = TXN.ORGANIZATION_ID 
                AND WMS_ENABLED_FLAG = 'N') --END TABLE 3
